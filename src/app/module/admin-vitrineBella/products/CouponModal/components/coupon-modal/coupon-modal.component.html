<!-- Header -->
<div class="modal-header">
  <div class="header-content">
    <div class="header-icon">
      <mat-icon>{{ data.mode === 'create' ? 'confirmation_number' : 'edit' }}</mat-icon>
    </div>
    <div class="header-text">
      <h4 class="modal-title">{{ title }}</h4>
      <p class="modal-subtitle">
        {{ data.mode === 'create' ? 'Crie um cupom de desconto para seus clientes' : 'Edite as informações do cupom' }}
      </p>
    </div>
  </div>
  <button mat-icon-button class="close-btn" (click)="onCancel()" aria-label="Fechar modal">
    <mat-icon>close</mat-icon>
  </button>
</div>

<!-- Body -->
<div class="modal-body">
  <form [formGroup]="couponForm" (ngSubmit)="onSubmit()" class="coupon-form">

    <!-- Informações do Cupom -->
    <div class="form-section">
      <div class="section-header">
        <mat-icon>confirmation_number</mat-icon>
        <h5>Informações do Cupom</h5>
      </div>

      <div class="form-row">
        <div class="form-field-half">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Código do Cupom</mat-label>
            <input matInput formControlName="code" placeholder="Ex: CUPOM2024" maxlength="20"
              (input)="formatCouponCode()" required />
            <mat-icon matSuffix>confirmation_number</mat-icon>
            <mat-hint>Máximo 20 caracteres</mat-hint>
            <mat-error *ngIf="couponForm.get('code')?.hasError('required')">
              Código do cupom é obrigatório
            </mat-error>
            <mat-error *ngIf="couponForm.get('code')?.hasError('minlength')">
              Mínimo 3 caracteres
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-field-half">
          <button type="button" mat-stroked-button class="generate-code-btn" (click)="generateNewCode()">
            <mat-icon>refresh</mat-icon>
            Gerar Novo Código
          </button>
        </div>
      </div>

      <div class="form-field-full">
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>Nome do Cupom</mat-label>
          <input matInput formControlName="name" placeholder="Ex: Black Friday 2024" maxlength="100" required />
          <mat-icon matSuffix>label</mat-icon>
          <mat-hint>Nome descritivo do cupom</mat-hint>
          <mat-error *ngIf="couponForm.get('name')?.hasError('required')">
            Nome do cupom é obrigatório
          </mat-error>
          <mat-error *ngIf="couponForm.get('name')?.hasError('minlength')">
            Mínimo 3 caracteres
          </mat-error>
        </mat-form-field>
      </div>

      <div class="form-field-full">
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>Descrição (Opcional)</mat-label>
          <textarea matInput formControlName="description" placeholder="Descreva as condições do cupom..." rows="2"
            maxlength="500"></textarea>
          <mat-icon matSuffix>description</mat-icon>
          <mat-hint>{{ couponForm.get('description')?.value?.length || 0 }}/500 caracteres</mat-hint>
        </mat-form-field>
      </div>
    </div>

    <!-- Configurações de Desconto -->
    <div class="form-section">
      <div class="section-header">
        <mat-icon>local_offer</mat-icon>
        <h5>Configurações de Desconto</h5>
      </div>

      <div class="form-row">
        <div class="form-field-half">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Percentual de Desconto (%)</mat-label>
            <input matInput formControlName="discountPercentage" type="number" min="1" max="100" placeholder="10"
              required />
            <mat-icon matSuffix>percent</mat-icon>
            <mat-hint>1% a 100%</mat-hint>
            <mat-error *ngIf="couponForm.get('discountPercentage')?.hasError('required')">
              Percentual é obrigatório
            </mat-error>
            <mat-error *ngIf="couponForm.get('discountPercentage')?.hasError('min')">
              Mínimo 1%
            </mat-error>
            <mat-error *ngIf="couponForm.get('discountPercentage')?.hasError('max')">
              Máximo 100%
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-field-half">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Valor Mínimo do Pedido (R$)</mat-label>
            <input matInput formControlName="minOrderValue" type="number" step="0.01" placeholder="0,00" />
            <mat-icon matSuffix>attach_money</mat-icon>
            <mat-hint>Valor mínimo para usar o cupom</mat-hint>
          </mat-form-field>
        </div>
      </div>

      <div class="form-field-full">
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>Desconto Máximo (R$)</mat-label>
          <input matInput formControlName="maxDiscountValue" type="number" step="0.01" placeholder="0,00" />
          <mat-icon matSuffix>money_off</mat-icon>
          <mat-hint>Limite máximo do desconto em reais</mat-hint>
        </mat-form-field>
      </div>
    </div>

    <!-- Período de Validade -->
    <div class="form-section">
      <div class="section-header">
        <mat-icon>event</mat-icon>
        <h5>Período de Validade</h5>
      </div>

      <div class="form-row">
        <div class="form-field-half">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Data de Início</mat-label>
            <input matInput formControlName="validFrom" type="date" />
            <mat-icon matSuffix>event</mat-icon>
            <mat-error *ngIf="couponForm.get('validFrom')?.hasError('required')">
              Data de início é obrigatória
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-field-half">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Data de Fim</mat-label>
            <input matInput formControlName="validUntil" type="date" />
            <mat-icon matSuffix>event_available</mat-icon>
            <mat-error *ngIf="couponForm.get('validUntil')?.hasError('required')">
              Data de fim é obrigatória
            </mat-error>
            <mat-error *ngIf="couponForm.get('validUntil')?.hasError('endDateInvalid')">
              Data de fim deve ser posterior à data de início
            </mat-error>
          </mat-form-field>
        </div>
      </div>
    </div>

    <!-- Configurações Avançadas -->
    <div class="form-section">
      <div class="section-header">
        <mat-icon>settings</mat-icon>
        <h5>Configurações Avançadas</h5>
      </div>

      <div class="form-field-full">
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>Limite de Uso</mat-label>
          <input matInput formControlName="usageLimit" type="number" min="1" placeholder="100" />
          <mat-icon matSuffix>repeat</mat-icon>
          <mat-hint>Número máximo de vezes que o cupom pode ser usado (deixe vazio para ilimitado)</mat-hint>
        </mat-form-field>
      </div>
    </div>

    <!-- Preview do Cupom -->
    <div class="coupon-preview" *ngIf="couponForm.get('code')?.value && couponForm.get('discountPercentage')?.value">
      <div class="section-header">
        <mat-icon>visibility</mat-icon>
        <h5>Pré-visualização do Cupom</h5>
      </div>

      <div class="preview-card">
        <div class="coupon-code">
          <span class="code-text">{{ couponForm.get('code')?.value }}</span>
          <button type="button" mat-icon-button class="copy-btn"
            (click)="copyToClipboard(couponForm.get('code')?.value)" matTooltip="Copiar código">
            <mat-icon>content_copy</mat-icon>
          </button>
        </div>
        <div class="coupon-info">
          <h6>{{ couponForm.get('name')?.value || 'Nome do Cupom' }}</h6>
          <p>{{ couponForm.get('description')?.value || 'Descrição do cupom...' }}</p>
          <div class="discount-info">
            <span class="discount-badge">
              <mat-icon>local_offer</mat-icon>
              {{ couponForm.get('discountPercentage')?.value }}% OFF
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Botões de Ação -->
    <div class="form-actions">
      <button type="button" mat-stroked-button class="cancel-btn" (click)="onCancel()">
        <mat-icon>cancel</mat-icon>
        Cancelar
      </button>
      <button type="submit" mat-raised-button color="primary" class="submit-btn"
        [disabled]="loading || couponForm.invalid">
        <div class="button-content">
          <mat-spinner *ngIf="loading" diameter="20" class="button-spinner"></mat-spinner>
          <mat-icon *ngIf="!loading">{{ data.mode === 'create' ? 'confirmation_number' : 'save' }}</mat-icon>
          <span *ngIf="!loading">{{ data.mode === 'create' ? 'Gerar Cupom' : 'Salvar Alterações' }}</span>
        </div>
      </button>
    </div>
  </form>
</div>
