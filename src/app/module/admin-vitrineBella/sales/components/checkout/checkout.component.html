<app-navigation-admin>
  <div class="checkout-container">
  <!-- Header -->
  <header class="checkout-header">
    <div class="header-content">
      <button mat-icon-button (click)="goToSalesPage()" class="back-button">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div class="header-text">
        <h1 class="header-title">
          <mat-icon>shopping_cart</mat-icon>
          Finalizar Compra
        </h1>
        <p class="header-subtitle">Complete os dados para finalizar sua compra</p>
      </div>
    </div>
  </header>

  <!-- Progress Steps -->
  <div class="progress-steps">
    <div class="steps-container">
      <div *ngFor="let step of steps" 
           class="step" 
           [class.active]="step.number === currentStep"
           [class.completed]="step.completed"
           (click)="goToStep(step.number)">
        <div class="step-number">
          <mat-icon *ngIf="step.completed">check</mat-icon>
          <span *ngIf="!step.completed">{{ step.number }}</span>
        </div>
        <div class="step-content">
          <mat-icon class="step-icon">{{ step.icon }}</mat-icon>
          <span class="step-title">{{ step.title }}</span>
        </div>
        <div class="step-line" *ngIf="step.number < totalSteps"></div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Etapa 1: Produtos -->
    <div *ngIf="currentStep === 1" class="step-content">
      <mat-card class="products-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>shopping_cart</mat-icon>
            Produtos Selecionados
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <!-- Empty Cart -->
          <div class="empty-cart" *ngIf="cartItems.length === 0">
            <mat-icon class="empty-icon">shopping_cart</mat-icon>
            <h3>Carrinho vazio</h3>
            <p>Você precisa adicionar produtos antes de finalizar a compra.</p>
            <button mat-raised-button color="primary" (click)="goToSalesPage()" class="go-to-sales-btn">
              <mat-icon>arrow_back</mat-icon>
              Voltar para Produtos
            </button>
          </div>

          <!-- Cart Items -->
          <div class="cart-items" *ngIf="cartItems.length > 0">
            <div class="cart-item" *ngFor="let item of cartItems">
              <div class="item-image">
                <img *ngIf="item.imageUrl" [src]="item.imageUrl" [alt]="item.productName">
                <mat-icon *ngIf="!item.imageUrl">image_not_supported</mat-icon>
              </div>
              <div class="item-info">
                <h4 class="item-name">{{ item.productName }}</h4>
                <p class="item-price">{{ item.productPrice | currency:'BRL' }} cada</p>
              </div>
              <div class="item-controls">
                <button mat-icon-button (click)="updateQuantity(item.productId, item.quantity - 1)"
                        [disabled]="item.quantity <= 1">
                  <mat-icon>remove</mat-icon>
                </button>
                <span class="quantity">{{ item.quantity }}</span>
                <button mat-icon-button (click)="updateQuantity(item.productId, item.quantity + 1)">
                  <mat-icon>add</mat-icon>
                </button>
              </div>
              <div class="item-total">
                {{ item.subtotal | currency:'BRL' }}
              </div>
              <button mat-icon-button color="warn" (click)="removeItem(item.productId)" class="remove-btn">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>

          <!-- Cart Summary -->
          <div class="cart-summary" *ngIf="cartItems.length > 0">
            <div class="summary-row">
              <span>Subtotal:</span>
              <span>{{ subtotal | currency:'BRL' }}</span>
            </div>
            <div class="summary-row total-row">
              <span><strong>Total:</strong></span>
              <span class="total-amount">{{ subtotal | currency:'BRL' }}</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Etapa 2: Cliente -->
    <div *ngIf="currentStep === 2" class="step-content">
      <!-- Resumo dos Produtos -->
      <mat-card class="products-summary-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>shopping_cart</mat-icon>
            Resumo da Compra
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="cart-items-summary">
            <div class="cart-item-summary" *ngFor="let item of cartItems">
              <div class="item-image">
                <img *ngIf="item.imageUrl" [src]="item.imageUrl" [alt]="item.productName">
                <mat-icon *ngIf="!item.imageUrl">image_not_supported</mat-icon>
              </div>
              <div class="item-info">
                <h5 class="item-name">{{ item.productName }}</h5>
                <p class="item-details">{{ item.quantity }}x {{ item.productPrice | currency:'BRL' }}</p>
              </div>
              <div class="item-total">
                {{ item.subtotal | currency:'BRL' }}
              </div>
            </div>
          </div>
          <div class="cart-summary">
            <div class="summary-row total-row">
              <span><strong>Total:</strong></span>
              <span class="total-amount">{{ total | currency:'BRL' }}</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <div class="customer-section">
        <!-- Busca de Cliente -->
        <mat-card class="customer-search-card">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>search</mat-icon>
              Buscar Cliente Existente
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <form [formGroup]="customerSearchForm" class="search-form">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Buscar por nome, email ou CPF</mat-label>
                <input matInput formControlName="searchTerm" placeholder="Digite o nome, email ou CPF do cliente"
                       (input)="onSearchInput($event)">
                <mat-icon matSuffix>search</mat-icon>
              </mat-form-field>
              <button mat-raised-button color="primary" (click)="searchCustomer()" 
                      [disabled]="customerSearchForm.invalid || isSearchingCustomer">
                <mat-spinner *ngIf="isSearchingCustomer" diameter="20" class="btn-spinner"></mat-spinner>
                <mat-icon *ngIf="!isSearchingCustomer">search</mat-icon>
                {{ isSearchingCustomer ? 'Buscando...' : 'Buscar Cliente' }}
              </button>
            </form>

            <!-- Cliente Encontrado -->
            <div *ngIf="foundCustomer" class="found-customer">
              <div class="customer-info">
                <mat-icon>person</mat-icon>
                <div class="customer-details">
                  <h4>{{ foundCustomer.name }}</h4>
                  <p>{{ foundCustomer.email }}</p>
                  <p>{{ foundCustomer.phone }}</p>
                </div>
              </div>
              <button mat-button color="accent" (click)="clearCustomerSearch()">
                <mat-icon>clear</mat-icon>
                Usar outro cliente
              </button>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Dados do Cliente -->
        <mat-card class="customer-data-card">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>person_add</mat-icon>
              {{ foundCustomer ? 'Dados do Cliente' : 'Novo Cliente' }}
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <form [formGroup]="customerDataForm" class="customer-form">
              <div class="form-row">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Nome Completo *</mat-label>
                  <input matInput formControlName="name" placeholder="Digite o nome completo">
                  <mat-icon matSuffix>person</mat-icon>
                  <mat-error>{{ customerNameError }}</mat-error>
                </mat-form-field>
              </div>

              <div class="form-row">
                <mat-form-field appearance="outline" class="half-width">
                  <mat-label>CPF *</mat-label>
                  <input matInput formControlName="cpf" placeholder="000.000.000-00" 
                         (input)="onCpfChange($event)" maxlength="14">
                  <mat-icon matSuffix>badge</mat-icon>
                  <mat-error>{{ cpfError }}</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="half-width">
                  <mat-label>Data de Nascimento</mat-label>
                  <input matInput type="date" formControlName="birthDate">
                  <mat-icon matSuffix>calendar_today</mat-icon>
                </mat-form-field>
              </div>

              <div class="form-row">
                <mat-form-field appearance="outline" class="half-width">
                  <mat-label>Email *</mat-label>
                  <input matInput formControlName="email" placeholder="email@exemplo.com">
                  <mat-icon matSuffix>email</mat-icon>
                  <mat-error>{{ emailError }}</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="half-width">
                  <mat-label>Telefone *</mat-label>
                  <input matInput formControlName="phone" placeholder="(00) 00000-0000" 
                         (input)="onPhoneChange($event)" maxlength="15">
                  <mat-icon matSuffix>phone</mat-icon>
                  <mat-error>{{ phoneError }}</mat-error>
                </mat-form-field>
              </div>

              <div class="form-row">
                <mat-form-field appearance="outline" class="half-width">
                  <mat-label>Gênero</mat-label>
                  <mat-select formControlName="gender">
                    <mat-option value="masculino">Masculino</mat-option>
                    <mat-option value="feminino">Feminino</mat-option>
                    <mat-option value="outro">Outro</mat-option>
                    <mat-option value="nao_informar">Não informar</mat-option>
                  </mat-select>
                  <mat-icon matSuffix>wc</mat-icon>
                </mat-form-field>
              </div>
            </form>
          </mat-card-content>
        </mat-card>
      </div>
    </div>

    <!-- Etapa 3: Pagamento -->
    <div *ngIf="currentStep === 3" class="step-content">
      <mat-card class="payment-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>payment</mat-icon>
            Forma de Pagamento
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <form [formGroup]="paymentForm" class="payment-form">
            <div class="payment-methods">
              <h3>Selecione a forma de pagamento:</h3>
              <div class="payment-options">
                <mat-radio-group formControlName="paymentMethod" class="payment-radio-group">
                  <mat-radio-button value="pix" class="payment-option">
                    <div class="payment-option-content">
                      <mat-icon>account_balance_wallet</mat-icon>
                      <span>PIX</span>
                      <small>Pagamento instantâneo</small>
                    </div>
                  </mat-radio-button>
                  
                  <mat-radio-button value="credit_card" class="payment-option">
                    <div class="payment-option-content">
                      <mat-icon>credit_card</mat-icon>
                      <span>Cartão de Crédito</span>
                      <small>Parcelado em até 12x</small>
                    </div>
                  </mat-radio-button>
                  
                  <mat-radio-button value="debit_card" class="payment-option">
                    <div class="payment-option-content">
                      <mat-icon>credit_card</mat-icon>
                      <span>Cartão de Débito</span>
                      <small>Débito automático</small>
                    </div>
                  </mat-radio-button>
                  
                  <mat-radio-button value="cash" class="payment-option">
                    <div class="payment-option-content">
                      <mat-icon>money</mat-icon>
                      <span>Dinheiro</span>
                      <small>Pagamento à vista</small>
                    </div>
                  </mat-radio-button>
                </mat-radio-group>
              </div>
            </div>

            <!-- Desconto -->
            <div class="discount-section">
              <h3>Desconto:</h3>
              <mat-form-field appearance="outline" class="discount-field">
                <input matInput type="number" formControlName="discount" 
                       (input)="onDiscountChange()" placeholder="0.00" min="0">
                <span matPrefix>R$&nbsp;</span>
              </mat-form-field>
            </div>

            <!-- Resumo Final -->
            <div class="final-summary">
              <h3>Resumo da Compra:</h3>
              <div class="summary-details">
                <div class="summary-row">
                  <span>Subtotal:</span>
                  <span>{{ subtotal | currency:'BRL' }}</span>
                </div>
                <div class="summary-row" *ngIf="discount > 0">
                  <span>Desconto:</span>
                  <span>-{{ discount | currency:'BRL' }}</span>
                </div>
                <div class="summary-row total-row">
                  <span><strong>Total:</strong></span>
                  <span class="total-amount">{{ total | currency:'BRL' }}</span>
                </div>
              </div>
            </div>
          </form>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Etapa 4: Confirmação -->
    <div *ngIf="currentStep === 4" class="step-content">
      <mat-card class="confirmation-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>check_circle</mat-icon>
            Confirmação da Compra
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <!-- Dados do Cliente -->
          <div class="confirmation-section">
            <h3>Dados do Cliente:</h3>
            <div class="confirmation-info">
              <p><strong>Nome:</strong> {{ customerDataForm.get('name')?.value }}</p>
              <p><strong>Email:</strong> {{ customerDataForm.get('email')?.value }}</p>
              <p><strong>Telefone:</strong> {{ customerDataForm.get('phone')?.value }}</p>
              <p><strong>CPF:</strong> {{ customerDataForm.get('cpf')?.value }}</p>
            </div>
          </div>

          <!-- Produtos -->
          <div class="confirmation-section">
            <h3>Produtos:</h3>
            <div class="confirmation-items">
              <div class="confirmation-item" *ngFor="let item of cartItems">
                <span>{{ item.productName }} x{{ item.quantity }}</span>
                <span>{{ item.subtotal | currency:'BRL' }}</span>
              </div>
            </div>
          </div>

          <!-- Pagamento -->
          <div class="confirmation-section">
            <h3>Pagamento:</h3>
            <div class="confirmation-info">
              <p><strong>Forma:</strong> {{ getPaymentMethodDisplayName(paymentForm.get('paymentMethod')?.value) }}</p>
              <p><strong>Desconto:</strong> {{ discount | currency:'BRL' }}</p>
              <p><strong>Total:</strong> {{ total | currency:'BRL' }}</p>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <!-- Navigation Buttons -->
  <div class="navigation-buttons">
    <button mat-button (click)="previousStep()" 
            [disabled]="currentStep === 1" class="prev-btn">
      <mat-icon>arrow_back</mat-icon>
      Voltar
    </button>

    <button mat-button (click)="clearCart()" 
            [disabled]="isProcessingSale" class="clear-btn">
      <mat-icon>clear</mat-icon>
      Cancelar Compra
    </button>

    <button mat-raised-button color="primary" 
            (click)="currentStep === 4 ? confirmPurchase() : nextStep()"
            [disabled]="!canProceedToNextStep() || isProcessingSale" 
            class="next-btn">
      <mat-spinner *ngIf="isProcessingSale" diameter="20" class="btn-spinner"></mat-spinner>
      <mat-icon *ngIf="!isProcessingSale">
        {{ currentStep === 4 ? 'check' : 'arrow_forward' }}
      </mat-icon>
      {{ isProcessingSale ? 'Processando...' : 
         currentStep === 4 ? 'Confirmar Compra' : 'Continuar' }}
    </button>
  </div>
</div>
</app-navigation-admin>
