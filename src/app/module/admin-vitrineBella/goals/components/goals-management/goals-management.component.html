<app-navigation-admin>
  <div class="goals-container">
    <!-- Header com estatísticas -->
    <mat-card class="stats-card mb-4">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>trending_up</mat-icon>
          Gerenciamento de Metas
        </mat-card-title>
        <mat-card-subtitle>Controle de metas mensais e ranking de vendas</mat-card-subtitle>
      </mat-card-header>

      <mat-card-content *ngIf="stats">
        <div class="stats-grid">
          <div class="stat-item">
            <mat-icon class="stat-icon">target</mat-icon>
            <div class="stat-content">
              <span class="stat-value">{{ stats.totalGoals }}</span>
              <span class="stat-label">Total de Metas</span>
            </div>
          </div>

          <div class="stat-item">
            <mat-icon class="stat-icon">check_circle</mat-icon>
            <div class="stat-content">
              <span class="stat-value">{{ stats.completedGoals }}</span>
              <span class="stat-label">Metas Concluídas</span>
            </div>
          </div>

          <div class="stat-item">
            <mat-icon class="stat-icon">trending_up</mat-icon>
            <div class="stat-content">
              <span class="stat-value">{{ formatPercentage(stats.averageAchievement) }}</span>
              <span class="stat-label">Média de Atingimento</span>
            </div>
          </div>

          <div class="stat-item">
            <mat-icon class="stat-icon">schedule</mat-icon>
            <div class="stat-content">
              <span class="stat-value">{{ getDaysRemaining() }}</span>
              <span class="stat-label">Dias Restantes</span>
            </div>
          </div>

          <div class="stat-item">
            <mat-icon class="stat-icon">attach_money</mat-icon>
            <div class="stat-content">
              <span class="stat-value">{{ formatCurrency(monthlyEarnings) }}</span>
              <span class="stat-label">Ganhos do Mês</span>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Filtros e controles -->
    <mat-card class="filter-card mb-4">
      <mat-card-content>
        <div class="filter-row">
          <!-- Período -->
          <mat-form-field appearance="outline" class="period-field">
            <mat-label>Mês</mat-label>
            <mat-select [(ngModel)]="selectedMonth" (selectionChange)="onPeriodChange()">
              <mat-option *ngFor="let month of [1,2,3,4,5,6,7,8,9,10,11,12]" [value]="month">
                {{ getMonthName(month) }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="period-field">
            <mat-label>Ano</mat-label>
            <mat-select [(ngModel)]="selectedYear" (selectionChange)="onPeriodChange()">
              <mat-option *ngFor="let year of [currentYear - 1, currentYear, currentYear + 1]" [value]="year">
                {{ year }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Busca -->
          <mat-form-field appearance="outline" class="search-field">
            <mat-label>Buscar</mat-label>
            <input matInput [(ngModel)]="searchTerm" (input)="onSearchChange($any($event.target).value)"
              placeholder="Buscar por usuário...">
            <mat-icon matSuffix>search</mat-icon>
          </mat-form-field>

          <!-- Filtro por status -->
          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>Status</mat-label>
            <mat-select [(ngModel)]="filter.status" (selectionChange)="onFilterChange()">
              <mat-option value="">Todos os status</mat-option>
              <mat-option value="active">Ativa</mat-option>
              <mat-option value="completed">Concluída</mat-option>
              <mat-option value="expired">Expirada</mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Botão criar meta -->
          <button mat-raised-button color="primary" (click)="createGoal()" *ngIf="canCreateGoal()"
            class="create-button">
            <mat-icon>add</mat-icon>
            Nova Meta
          </button>

          <!-- Botão fechamento do mês -->
          <button mat-raised-button color="accent" (click)="openMonthClosing()"
            *ngIf="canCreateGoal() && canCloseMonth()" class="close-button">
            <mat-icon>event_available</mat-icon>
            Fechar Mês
          </button>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Ranking de vendas -->
    <mat-card class="ranking-card mb-4">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>emoji_events</mat-icon>
          Ranking de Vendas - {{ getMonthName(selectedMonth) }} {{ selectedYear }}
        </mat-card-title>
      </mat-card-header>

      <mat-card-content>
        <div class="ranking-list" *ngIf="getRankingData().length > 0; else noRanking">
          <div class="ranking-item" *ngFor="let ranking of getRankingData(); let i = index"
            [class.top-three]="ranking.rank <= 3">
            <div class="rank-position">
              <mat-icon *ngIf="ranking.rank === 1" class="trophy gold">emoji_events</mat-icon>
              <mat-icon *ngIf="ranking.rank === 2" class="trophy silver">emoji_events</mat-icon>
              <mat-icon *ngIf="ranking.rank === 3" class="trophy bronze">emoji_events</mat-icon>
              <span *ngIf="ranking.rank > 3" class="rank-number">{{ ranking.rank }}º</span>
            </div>

            <div class="ranking-info">
              <div class="user-info">
                <mat-icon>person</mat-icon>
                <span class="user-name">{{ ranking.userName }}</span>
              </div>
              <div class="sales-info">
                <span class="sales-amount">{{ formatCurrency(ranking.totalSales) }}</span>
                <span class="achievement">{{ formatPercentage(ranking.goalAchievement) }}</span>
              </div>
            </div>

            <div class="commission-info">
              <mat-icon>attach_money</mat-icon>
              <span>{{ formatCurrency(ranking.commission) }}</span>
            </div>
          </div>
        </div>

        <ng-template #noRanking>
          <div class="no-data">
            <mat-icon>emoji_events</mat-icon>
            <p>Nenhum dado de ranking disponível para este período</p>
          </div>
        </ng-template>
      </mat-card-content>
    </mat-card>

    <!-- Tabela de metas -->
    <mat-card>
      <mat-card-content>
        <div class="table-container" *ngIf="!isLoading; else loadingTemplate">
          <table mat-table [dataSource]="dataSource" matSort class="goals-table">

            <!-- Coluna Usuário -->
            <ng-container matColumnDef="userName">
              <th mat-header-cell *matHeaderCellDef mat-sort-header class="text-center">Usuário</th>
              <td mat-cell *matCellDef="let goal" class="text-center">
                <div class="user-cell">
                  <app-avatar [name]="goal.userName" [photoUrl]="getPhotoUrl(goal.userId)" [size]="28"
                    [showBorder]="true"></app-avatar>
                  <span>{{ goal.userName }}</span>
                </div>
              </td>
            </ng-container>

            <!-- Coluna Mês -->
            <ng-container matColumnDef="month">
              <th mat-header-cell *matHeaderCellDef class="text-center">Período</th>
              <td mat-cell *matCellDef="let goal" class="text-center">
                {{ getMonthName(goal.month) }} {{ goal.year }}
              </td>
            </ng-container>

            <!-- Coluna Meta -->
            <ng-container matColumnDef="targetAmount">
              <th mat-header-cell *matHeaderCellDef mat-sort-header class="text-center">Meta</th>
              <td mat-cell *matCellDef="let goal" class="text-center">
                {{ formatCurrency(goal.targetAmount) }}
              </td>
            </ng-container>

            <!-- Coluna Atual -->
            <ng-container matColumnDef="currentAmount">
              <th mat-header-cell *matHeaderCellDef mat-sort-header class="text-center">Vendas Atuais</th>
              <td mat-cell *matCellDef="let goal" class="text-center">
                {{ formatCurrency(goal.currentAmount) }}
              </td>
            </ng-container>

            <!-- Coluna Progresso -->
            <ng-container matColumnDef="progress">
              <th mat-header-cell *matHeaderCellDef class="text-center">Progresso</th>
              <td mat-cell *matCellDef="let goal" class="text-center">
                <div class="progress-container">
                  <mat-progress-bar [value]="goalService.getGoalProgress(goal)"
                    [color]="getProgressColor(goalService.getGoalProgress(goal))">
                  </mat-progress-bar>
                  <span class="progress-text">{{ formatPercentage(goalService.getGoalProgress(goal))
                    }}</span>
                </div>
              </td>
            </ng-container>

            <!-- Coluna Comissão -->
            <ng-container matColumnDef="commission">
              <th mat-header-cell *matHeaderCellDef class="text-center">Comissão</th>
              <td mat-cell *matCellDef="let goal" class="text-center">
                <div class="commission-cell">
                  <span class="commission-percentage">{{ goal.commissionPercentage }}%</span>
                  <span class="commission-amount">{{ formatCurrency(goal.currentAmount *
                    (goal.commissionPercentage / 100)) }}</span>
                </div>
              </td>
            </ng-container>

            <!-- Coluna Status -->
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef class="text-center">Status</th>
              <td mat-cell *matCellDef="let goal" class="text-center">
                <mat-chip [color]="getStatusColor(goal.status)" selected>
                  <mat-icon matChipAvatar>{{ goal.status === 'completed' ? 'check_circle' :
                    goal.status === 'active' ? 'schedule' : 'warning' }}</mat-icon>
                  {{ getStatusText(goal.status) }}
                </mat-chip>
              </td>
            </ng-container>

            <!-- Coluna Ações -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef class="text-center">Ações</th>
              <td mat-cell *matCellDef="let goal" class="text-center">
                <div class="action-buttons">
                  <button mat-icon-button color="primary" (click)="updateSales(goal)" matTooltip="Atualizar Vendas">
                    <mat-icon>add_shopping_cart</mat-icon>
                  </button>

                  <button mat-icon-button color="accent" (click)="editGoal(goal)" *ngIf="canEditGoal(goal)"
                    matTooltip="Editar Meta">
                    <mat-icon>edit</mat-icon>
                  </button>

                  <button mat-icon-button color="warn" (click)="deleteGoal(goal)" *ngIf="canEditGoal(goal)"
                    matTooltip="Excluir Meta">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>

          <!-- Mensagem quando não há metas -->
          <div *ngIf="!isLoading && dataSource.data.length === 0" class="no-data">
            <mat-icon>target</mat-icon>
            <h3>Nenhuma meta encontrada</h3>
            <p>Não há metas para o período selecionado.</p>
            <button mat-raised-button color="primary" (click)="createGoal()" *ngIf="canCreateGoal()">
              <mat-icon>add</mat-icon>
              Criar Primeira Meta
            </button>
          </div>

          <!-- Paginação -->
          <mat-paginator [length]="dataSource.data.length" [pageSize]="10" [pageSizeOptions]="[5, 10, 25, 50]"
            showFirstLastButtons>
          </mat-paginator>
        </div>

        <!-- Loading template -->
        <ng-template #loadingTemplate>
          <div class="loading-container">
            <mat-spinner></mat-spinner>
            <p>Carregando metas...</p>
          </div>
        </ng-template>

      </mat-card-content>
    </mat-card>
  </div>
</app-navigation-admin>
